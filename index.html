<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบตรวจสอบความพร้อมรถ Emergency & ตารางยาและเวชภัณฑ์</title>
  <!-- Google Fonts & Bootstrap & Icon -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --mint-gradient: linear-gradient(135deg, #e8fff0 0%, #d3f3e2 40%, #e0f6e9 100%);
      --mint-btn: linear-gradient(90deg, #24d4a3 0%, #a6ffcb 100%);
      --mint-outline: #24d4a3;
      --mint-btn-shadow: rgba(36, 212, 163, 0.13);
      --mint-label: #18805c;
      --mint-title: #18805c;
      --mint-white: #fff;
      --mint-accent: #24d4a3;
      --primary: #20c997;
      --primary-dark: #15a37f;
      --primary-light: #d1f2ea;
      --secondary: #5a6268;
      --light: #f8f9fa;
      --dark: #343a40;
      --danger-light: #ffe6e6;
      --danger-dark: #dc3545;
      --warning: #ffb26b;
      --success: #d1f2ea;
            --mint-primary: #4dd6a5;
            --mint-secondary: #3ac7b6;
            --mint-light: #e0f7f0;
            --mint-dark: #2a9d8f;
            --mint-danger: #ffcccb;
            --mint-danger-dark: #ff6b6b;
            --mint-warning: #ffd8b1;
            --mint-success: #c1f7d5;
    }
    body {
      font-family: 'Kanit', 'Sarabun', sans-serif;
      background: var(--mint-gradient);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding-top: 2.5rem;
      padding-bottom: 2.5rem;
    }
    .container {
      max-width: 900px;
      width: 100%;
      background: var(--mint-gradient);
      border-radius: 2rem;
      box-shadow: 0 8px 40px 0 var(--mint-btn-shadow), 0 3px 12px 0 rgba(0,0,0,0.07);
      padding: 2.3rem 1.2rem 1.5rem 1.2rem;
      border: 2.5px solid var(--mint-outline);
      margin-bottom: 2rem;
    }
    @media (max-width: 900px) {
      .container { padding: 0.7rem 0.2rem !important; max-width: 99vw; }
    }
    @media (max-width: 600px) {
      .container { padding: 0.2rem 1vw !important; max-width: 99vw; }
    }
    .profile-box {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .profile-img {
      width: 74px;
      height: 74px;
      border-radius: 100px;
      object-fit: cover;
      box-shadow: 0 2px 10px #b7ffe2;
      border: 3px solid var(--mint-white);
      display: inline-block;
      margin-bottom: 0.5rem;
      margin-top: 0;
      background: var(--mint-gradient);
    }
    .profile-name {
      font-size: 1.12em;
      font-weight: 600;
      color: var(--mint-label);
      margin-top: 0.3rem;
      margin-bottom: 0;
      word-break: break-word;
      text-shadow: 0 2px 8px #fff2;
    }
    .navbar {
            background-color: var(--mint-primary);
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: var(--mint-secondary);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 15px 20px;
        }
        
        .table {
            margin-bottom: 0;
            font-size: 0.75rem; /* ลดขนาดตัวอักษรในตาราง */
        }
        
        .table th {
            background-color: var(--mint-light);
            color: var(--mint-dark);
            border-color: #e9ecef;
            font-size: 0.8rem; /* ขนาดตัวอักษรหัวตาราง */
        }
        
.status-expired {
  background-color: #ff0000 !important; /* สีแดงสด */
  color: white !important;
}
        
        .status-near-expired {
            background-color: var(--mint-danger) !important;
        }
        
        .status-warning {
            background-color: var(--mint-warning) !important;
        }
        
        .status-normal {
            background-color: var(--mint-success) !important;
        }
        
        .btn-mint {
            background-color: var(--mint-primary);
            color: white;
        }
        
        .btn-mint:hover {
            background-color: var(--mint-dark);
            color: white;
        }
        
        .action-btn {
            padding: 4px 8px;
            margin: 0 2px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-container {
            text-align: center;
        }
        
        .modal-header {
            background-color: var(--mint-secondary);
            color: white;
        }
        
        .modal-content {
            border-radius: 15px;
        }
        
        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
            min-width: 300px;
            text-align: center;
            font-size: 1.2rem;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .status-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        
        /* ป้องกันการตัดคำในคอลัมน์จำนวนวันที่ใกล้หมดอายุ */
        .days-column {
            white-space: nowrap;
        }
        
        /* สไตล์สำหรับ input group ในฟอร์ม */
        .form-icon {
            background-color: var(--mint-light);
            color: var(--mint-dark);
            border-color: #ced4da;
        }
        
        .form-control:focus {
            border-color: var(--mint-primary);
            box-shadow: 0 0 0 0.25rem rgba(77, 214, 165, 0.25);
        }
        
        /* ปรับขนาด badge ในตาราง */
        .table .badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.7rem; /* ลดขนาดตัวอักษรในตารางสำหรับมือถือ */
            }
            
            .action-btn {
                padding: 2px 5px;
                font-size: 0.7rem;
            }
            
            /* อนุญาตให้ตัดคำในสมาร์ทโฟน */
            .days-column {
                white-space: normal;
            }
            
            /* ปรับขนาด badge ในตารางสำหรับมือถือ */
            .table .badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
            
            /* ปรับขนาดไอคอนในตารางสำหรับมือถือ */
            .table .bi {
                font-size: 0.7rem;
            }
            
            /* ปรับขนาดหัวตารางสำหรับมือถือ */
            .table th {
                font-size: 0.7rem;
                padding: 0.4rem;
            }
            
            /* ปรับขนาดเซลล์ในตารางสำหรับมือถือ */
            .table td {
                padding: 0.4rem;
            }
            
            /* ปรับขนาดของ status badges สำหรับมือถือ */
            .status-badges {
                gap: 5px;
            }
            
            .status-badge {
                padding: 3px 6px;
                font-size: 0.7rem;
            }
            
            /* ปรับขนาดของ modal สำหรับมือถือ */
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .modal-title {
                font-size: 1.1rem;
            }
            
            .form-label {
                font-size: 0.85rem;
            }
        }
        
        /* สำหรับหน้าจอขนาดเล็กมาก */
        @media (max-width: 576px) {
            .table-responsive {
                font-size: 0.65rem;
            }
            
            .action-btn {
                padding: 1px 4px;
                font-size: 0.65rem;
                margin: 0 1px;
            }
            
            /* ปรับขนาดเซลล์ในตารางสำหรับหน้าจอเล็กมาก */
            .table td, .table th {
                padding: 0.3rem;
            }
            
            /* ปรับขนาดของ card header สำหรับหน้าจอเล็กมาก */
            .card-header {
                padding: 10px 15px;
            }
            
            .card-header h5 {
                font-size: 1rem;
            }
            
            /* ปรับขนาดของปุ่มเพิ่มรายการสำหรับหน้าจอเล็กมาก */
            #addNewItem {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }
    .main-title {
      color: var(--mint-label);
      font-weight: 700 !important;
      font-size: 1.72em;
      margin-bottom: 2rem !important;
      text-shadow: 0 2px 8px #fff8;
      line-height: 1.2;
    }
    .drug-table-section {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 2px 16px #a6ffcb22;
      padding: 1.3rem 0.7rem 1.2rem 0.7rem;
      margin-bottom: 2.3rem;
    }
    .drug-table-section h3 {
      color: #24d4a3;
      font-weight: bold;
      letter-spacing: .01em;
      font-size: 1.18em;
      margin-bottom: 1.1rem;
      text-align: left;
    }
    #drug-expiry-list {
      font-size: 0.92em;
    }
    #drug-expiry-list thead th, #drug-expiry-list tbody td { padding: 0.29rem 0.29rem; }
    #drug-expiry-list tbody tr:nth-child(even) {
      background-color: rgba(209, 242, 234, 0.25);
    }

    .status-red { background-color: rgba(255, 107, 107, 0.13) !important; }
    .status-orange { background-color: rgba(255, 178, 107, 0.13) !important; }
    .status-green { background-color: rgba(107, 255, 170, 0.13) !important; }
    .badge-expired { background-color: #dc3545; color: white; }
    .badge-red { background-color: #ff6b6b; color: white; }
    .badge-orange { background-color: #ffb26b; color: white; }
    .badge-green { background-color: #6bffa9; color: #343a40; }
    label, .form-label {
      color: var(--mint-label);
      font-weight: 500;
    }
    .section-title {
      background: linear-gradient(90deg, #bafee5 0%, #e0fff4 100%);
      color: #18805c;
      padding: 0.65rem 1rem;
      border-radius: 15px;
      margin-bottom: 1.1rem;
      font-size: 1.08em;
      font-weight: bold;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      border: 1.5px solid #a6ffcb;
      box-shadow: 0 1px 8px #fff3;
    }
    .section-title i {
      font-size: 1.21em;
      color: #24d4a3c0;
    }
    .qrcode-sec {
      background: linear-gradient(90deg, #eafff6 0%, #e8fff0 100%);
      border-radius: 12px;
      padding: 0.7rem 1rem 1rem 1rem;
      margin-bottom: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      border: 1.5px solid #a6ffcb;
      box-shadow: 0 1px 8px #fff4;
    }
    .qrcode-btn {
      background: var(--mint-btn);
      color: #18805c;
      border: none;
      border-radius: 15px;
      font-weight: 600;
      font-size: 1.06em;
      padding: 0.65em 1.7em;
      box-shadow: 0 1px 8px var(--mint-btn-shadow);
      cursor: pointer;
      transition: background .14s, box-shadow .14s;
      display: flex;
      align-items: center;
      gap: 0.6em;
      margin: 0 auto;
      letter-spacing: .02em;
      border: 1.5px solid #a6ffcb;
    }
    .qrcode-btn:active, .qrcode-btn:focus {
      background: #eafff6;
      color: #18805c;
      box-shadow: 0 3px 16px #a6ffcb77;
      outline: none;
      border: 2px solid #24d4a3;
    }
    .signature-pad {
      border: 1.5px solid #a6ffcb;
      border-radius: 13px;
      width: 100%;
      height: 120px;
      background: #fff;
      cursor: crosshair;
      box-shadow: 0 1px 8px #fff2;
    }
    .btn-blue {
      background: var(--mint-btn);
      color: #18805c;
      border: none;
      font-weight: 600;
      border-radius: 22px;
      padding: 0.95em 2.2em;
      box-shadow: 0 2px 12px #a6ffcb66;
      transition: 0.18s;
      border: 1.5px solid #a6ffcb;
      font-size: 1.13em;
      letter-spacing: .03em;
    }
    .btn-blue:hover {
      background: #eafff6;
      color: #18805c;
    }
    .developer-credit {
      text-align: center;
      color: #18805c;
      font-size: 1rem;
      margin-top: 2rem;
      font-weight: 500;
      opacity: .85;
      letter-spacing: .03em;
      text-shadow: 0 1px 6px #fff4;
    }
    input, select, textarea {
      background: #fff;
      border: 1.5px solid #a6ffcb !important;
      color: #18805c !important;
      border-radius: 12px !important;
      box-shadow: 0 1px 6px #fff2;
      font-size: 1em !important;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #24d4a3 !important;
      box-shadow: 0 0 10px #a6ffcb55;
      background: #f8f8ff;
      outline: none !important;
    }
    .table-responsive { overflow-x: auto; }
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1060;
    }
    .toast { min-width: 220px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <!-- JS/CSS CDN -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
</head>
<body>
  <div class="container">
    <h2 class="mb-3 text-center main-title">
      <i class="fas fa-ambulance me-2"></i> ระบบตรวจสอบความพร้อม<br>รถ Emergency
    </h2>
     <div class="profile-box">
      <img id="profilePic" class="profile-img d-none" src="" alt="profile">
      <div class="profile-name" id="profileName"></div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-2">กำลังโหลดข้อมูล...</p>
        </div>
    </div>

    <div id="notification" class="alert alert-dismissible fade show" role="alert">
        <span id="notificationMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
      <h5 class="mb-0"><i class="bi bi-table me-2"></i>รายการยาและเวชภัณฑ์</h5>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-mint btn-sm" id="refreshData">
        <i class="bi bi-arrow-clockwise me-1"></i>รีเฟรชข้อมูล
      </button>
      <button class="btn btn-light btn-sm" id="addNewItem">
        <i class="bi bi-plus-circle me-1"></i>เพิ่มรายการ
      </button>
    </div>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-12 mb-2">
        <div class="input-group">
          <span class="input-group-text bg-light">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control" id="searchInput" placeholder="ค้นหายาหรือเวชภัณฑ์...">
        </div>
      </div>
      <div class="col-12">
        <div class="status-badges">
          <div class="status-badge status-expired">
            <i class="bi bi-exclamation-triangle me-1"></i>หมดอายุ
          </div>
          <div class="status-badge status-near-expired">
            <i class="bi bi-exclamation-circle me-1"></i>ใกล้หมดอายุ
          </div>
          <div class="status-badge status-warning">
            <i class="bi bi-clock me-1"></i>รีบแลกยาด่วน
          </div>
          <div class="status-badge status-normal">
            <i class="bi bi-check-circle me-1"></i>ปกติ
          </div>
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover" id="medicineTable">
        <thead>
          <tr>
            <th scope="col" style="width: 30%">ยา/เวชภัณฑ์</th>
            <th scope="col" style="width: 30%">จำนวนวันที่ใกล้หมดอายุ</th>
            <th scope="col" style="width: 20%">สถานะ</th>
            <th scope="col" style="width: 20%">การจัดการ</th>
          </tr>
        </thead>
        <tbody id="medicineTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

    <!-- Modal สำหรับดูและแก้ไขข้อมูล -->
    <div class="modal fade" id="medicineModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">รายละเอียดยา/เวชภัณฑ์</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="medicineForm">
                        <input type="hidden" id="rowIndex">
                        <input type="hidden" id="sheetRowIndex">
                        <div class="mb-3">
                            <label for="medicineName" class="form-label">ยา/เวชภัณฑ์</label>
                            <div class="input-group">
                                <span class="input-group-text form-icon">
                                    <i class="bi bi-capsule"></i>
                                </span>
                                <input type="text" class="form-control" id="medicineName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="expiryDate" class="form-label">วันหมดอายุ</label>
                            <div class="input-group">
                                <span class="input-group-text form-icon">
                                    <i class="bi bi-calendar-event"></i>
                                </span>
                                <input type="date" class="form-control" id="expiryDate" required onchange="calculateDaysUntilExpiry()">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="daysUntilExpiry" class="form-label">จำนวนวันที่ใกล้หมดอายุ</label>
                            <div class="input-group">
                                <span class="input-group-text form-icon">
                                    <i class="bi bi-hourglass-split"></i>
                                </span>
                                <input type="number" class="form-control" id="daysUntilExpiry" readonly>
                                <span class="input-group-text">วัน</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">สถานะ</label>
                            <div class="input-group">
                                <span class="input-group-text form-icon">
                                    <i class="bi bi-info-circle"></i>
                                </span>
                                <input type="text" class="form-control" id="status" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">หมายเหตุ</label>
                            <div class="input-group">
                                <span class="input-group-text form-icon">
                                    <i class="bi bi-pencil"></i>
                                </span>
                                <textarea class="form-control" id="notes" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>ปิด
                    </button>
                    <button type="button" class="btn btn-mint" id="saveChanges">
                        <i class="bi bi-save me-1"></i>บันทึกการเปลี่ยนแปลง
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ยืนยันการลบ -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>ยืนยันการลบ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?</p>
                    <p id="deleteItemName" class="fw-bold"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>ยกเลิก
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">
                        <i class="bi bi-trash me-1"></i>ลบ
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Emergency Form (copy from your previous code, unchanged) -->
<form id="emergency-check-form" autocomplete="off" novalidate>
      <div class="mb-4 row g-3">
        <div class="col-md-4">
          <label for="shift" class="form-label"><i class="far fa-clock me-1"></i> เวร</label>
          <select class="form-select" id="shift" name="shift" required>
            <option value="">เลือกเวร</option>
            <option value="เวรเช้า">เวรเช้า</option>
            <option value="เวรบ่าย">เวรบ่าย</option>
            <option value="เวรดึก">เวรดึก</option>
          </select>
        </div>
        <div class="col-md-8">
          <label for="recordId" class="form-label"><i class="fas fa-id-badge me-1"></i> ID (วันที่+เวรที่เลือก)</label>
          <input type="text" class="form-control" id="recordId" name="recordId" readonly>
        </div>
      </div>
      <div class="qrcode-sec mb-3">
        <button type="button" class="qrcode-btn" id="scan-section1-btn">
          <i class="fas fa-qrcode"></i> สแกนคิวอาร์โค้ด
        </button>
      </div>
      <!-- ชั้นที่ 1 (สแกน QR เท่านั้น) -->
      <div class="section-title"><i class="fas fa-layer-group"></i> ชั้นที่ 1</div>
      <div id="section1" class="row g-3 d-none">
        <div class="col-md-4"><label class="form-label">Adrenaline (1:1000) 10 amp</label><input type="number" min="0" name="adrenaline" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Amiodarone 3 amp</label><input type="number" min="0" name="amiodarone" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Atropine (0.6 mg/amp.) 5 amp</label><input type="number" min="0" name="atropine" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Adenosine (6 mg./vial) 1 amp</label><input type="number" min="0" name="adenosine" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">10% Calcium Gluconate (10 ml./amp.) 2 amp</label><input type="number" min="0" name="calcium" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">50% Glucose (50 ml./vial) 2 vial</label><input type="number" min="0" name="glucose" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">50% MgSO4 (2 ml./amp. หรือ 1 mg./amp.) 2 amp</label><input type="number" min="0" name="mgso4" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">7.5% NaHCO3 (50 ml./amp.) 2 amp</label><input type="number" min="0" name="nahco3" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Valium (10 mg./amp.) 2 amp</label><input type="number" min="0" name="valium" required class="form-control"></div>
        <div class="col-md-6"><label class="form-label">Syringe Disposable ขนาดต่างๆ อย่างละ 3</label><input type="number" min="0" name="syringe" required class="form-control"></div>
        <div class="col-md-6"><label class="form-label">เข็มฉีดยา เบอร์18-24 อย่างละ 3</label><input type="number" min="0" name="needle" required class="form-control"></div>
      </div>
      <!-- ชั้นที่ 2 -->
      <div class="section-title mt-4"><i class="fas fa-layer-group"></i> ชั้นที่ 2</div>
      <div id="section2" class="row g-3 d-none">
        <div class="col-md-4"><label class="form-label">IV Catheter No. 24, 22, 20, 18 อย่างละ 3</label>
          <select class="form-select" name="iv_catheter" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">0.9% NSS 1,000 ml 1 ขวด</label>
          <select class="form-select" name="nss" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">Set IV 3 set</label><input type="number" min="0" name="set_iv" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Extension Tube 3 set</label><input type="number" min="0" name="extension_tube" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Three-way 3 อัน</label><input type="number" min="0" name="three_way" required class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Transpore 1 นิ้ว 1ม้วน</label>
          <select class="form-select" name="transpore" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">Tourniquet</label>
          <select class="form-select" name="tourniquet" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">กรรไกร 1</label>
          <select class="form-select" name="scissors" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">ชามรูปไต</label>
          <select class="form-select" name="kidney_dish" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">ไฟฉาย</label>
          <select class="form-select" name="flashlight" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">แว่นตา อย่างละ 1</label>
          <select class="form-select" name="goggles" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
      </div>
      <!-- ชั้นที่ 3 -->
      <div class="section-title mt-4"><i class="fas fa-layer-group"></i> ชั้นที่ 3</div>
      <div id="section3" class="row g-3 d-none">
        <div class="col-md-4"><label class="form-label">ET-Tube No.7, 7.5, 8.0 อย่างละ 2</label>
          <select class="form-select" name="et_tube" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">Laryngoscope + Blade (พร้อมถ่าน) 1 ชุด</label>
          <select class="form-select" name="laryngoscope" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">Guide wire</label>
          <select class="form-select" name="guide_wire" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">Magill Forceps อย่างละ 1</label>
          <select class="form-select" name="magill_forceps" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">Oropharyngeal Airway 2 อัน</label>
          <input type="number" min="0" name="airway" required class="form-control">
        </div>
        <div class="col-md-4"><label class="form-label">K-Y Jelly 1</label>
          <input type="number" min="0" name="ky_jelly" required class="form-control">
        </div>
        <div class="col-md-4"><label class="form-label">สาย Suction No.14, 16 อย่างละ 1</label>
          <input type="number" min="0" name="suction" required class="form-control">
        </div>
        <div class="col-md-4"><label class="form-label">พลาสเตอร์เหนียวติด Tube</label>
          <input type="number" min="0" name="tube_plaster" required class="form-control">
        </div>
      </div>
      <!-- ชั้นที่ 4 -->
      <div class="section-title mt-4"><i class="fas fa-layer-group"></i> ชั้นที่ 4</div>
      <div id="section4" class="row g-3 d-none">
        <div class="col-md-4"><label class="form-label">กระดานและปากกา อย่างละ 1</label>
          <select class="form-select" name="board_pen" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">ใบ CPR Record</label>
          <select class="form-select" name="cpr_record" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">Stethoscope</label>
          <select class="form-select" name="stethoscope" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">ถุงมือ</label>
          <select class="form-select" name="gloves" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">Mask อย่างละ 2</label>
          <select class="form-select" name="mask" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
      </div>
      <!-- ชั้นที่ 5 -->
      <div class="section-title mt-4"><i class="fas fa-layer-group"></i> ชั้นที่ 5</div>
      <div id="section5" class="row g-3 d-none">
        <div class="col-md-4"><label class="form-label">Ambu bag + Mask 1 ชุด</label>
          <select class="form-select" name="ambu_bag" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">O2 Mask bag</label>
          <select class="form-select" name="o2_mask" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">O2 cannula อย่างละ 1</label>
          <select class="form-select" name="o2_cannula" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">สายต่อออกซิเจน 1 เส้น</label>
          <select class="form-select" name="o2_tube" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
        <div class="col-md-4"><label class="form-label">CPR Board</label>
          <select class="form-select" name="cpr_board" required><option value="">เลือก</option><option>✔</option><option>✘</option></select>
        </div>
      </div>
      <div class="mt-4 row g-3 align-items-end">
        <div class="col-md-6">
          <label for="inspector" class="form-label"><i class="fas fa-user-check me-1"></i> ผู้ตรวจสอบ</label>
          <input type="text" class="form-control" id="inspector" name="inspector" required>
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="fas fa-signature me-1"></i> เซ็นชื่อ</label>
          <canvas id="signaturePad" class="signature-pad"></canvas>
          <button class="btn btn-outline-secondary btn-sm mt-2" id="clear-signature" type="button">
            <i class="fas fa-eraser me-1"></i> ลบลายเซ็น
          </button>
        </div>
      </div>
      <div class="d-flex justify-content-center mt-5">
        <button class="btn btn-blue px-5 py-2" type="submit">
          <i class="fas fa-save"></i> บันทึกข้อมูล
        </button>
      </div>
    </form>
    <div class="developer-credit">
      พัฒนาโดย ทีม IT Nurse กลุ่มการพยาบาล
    </div>
  </div>
  <!-- Drug CRUD Modals -->
  <!-- View Details Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-mint" style="background-color: #20c997;">
          <h5 class="modal-title">รายละเอียดยา/เวชภัณฑ์</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="viewModalContent"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-mint" style="background-color: #20c997;">
          <h5 class="modal-title">แก้ไขข้อมูลยา/เวชภัณฑ์</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editRowIndex">
            <div class="mb-3">
              <label for="editName" class="form-label">ยา/เวชภัณฑ์</label>
              <input type="text" class="form-control" id="editName" required>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="editExpDay" class="form-label">วันที่หมดอายุ</label>
                <input type="number" class="form-control" id="editExpDay" min="1" max="31" required>
              </div>
              <div class="col-md-4">
                <label for="editExpMonth" class="form-label">เดือนที่หมดอายุ</label>
                <input type="number" class="form-control" id="editExpMonth" min="1" max="12" required>
              </div>
              <div class="col-md-4">
                <label for="editExpYear" class="form-label">ปี ค.ศ. หมดอายุ</label>
                <input type="number" class="form-control" id="editExpYear" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="editNote" class="form-label">หมายเหตุ</label>
              <textarea class="form-control" id="editNote" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="button" id="saveEditBtn" class="btn btn-mint">บันทึก</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Add New Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-mint" style="background-color: #20c997;">
          <h5 class="modal-title">เพิ่มยา/เวชภัณฑ์ใหม่</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            <div class="mb-3">
              <label for="addName" class="form-label">ยา/เวชภัณฑ์</label>
              <input type="text" class="form-control" id="addName" required>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="addExpDay" class="form-label">วันที่หมดอายุ</label>
                <input type="number" class="form-control" id="addExpDay" min="1" max="31" required>
              </div>
              <div class="col-md-4">
                <label for="addExpMonth" class="form-label">เดือนที่หมดอายุ</label>
                <input type="number" class="form-control" id="addExpMonth" min="1" max="12" required>
              </div>
              <div class="col-md-4">
                <label for="addExpYear" class="form-label">ปี ค.ศ. หมดอายุ</label>
                <input type="number" class="form-control" id="addExpYear" required>
              </div>
            </div>
            <div class="mb-3">
              <label for="addNote" class="form-label">หมายเหตุ</label>
              <textarea class="form-control" id="addNote" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="button" id="saveAddBtn" class="btn btn-mint">บันทึก</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Confirm Delete Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">ยืนยันการลบ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>คุณต้องการลบรายการ <span id="deleteItemName" class="fw-bold"></span> ใช่หรือไม่?</p>
          <p class="text-muted small">การดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
        </div>
        <div class="modal-footer">
          <input type="hidden" id="deleteRowIndex">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="button" id="confirmDeleteBtn" class="btn btn-danger">ลบ</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Toast Notifications -->
  <div class="toast-container">
    <div id="toast" class="toast align-items-center text-white bg-mint border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i id="toastIcon" class="fas fa-check-circle me-2"></i>
          <span id="toastMessage">บันทึกข้อมูลสำเร็จ</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>

  <!-- Modal QR -->
  <div id="qr-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content">
        <div class="modal-header" style="background-color:#24d4a3;border-top-left-radius:1rem;border-top-right-radius:1rem;">
          <h5 class="modal-title" style="color:#fff;"><i class="fas fa-qrcode me-2"></i> สแกน QR Code</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="qr-reader" style="width:100%;"></div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- LIFF/LINE profile logic (เหมือนเดิม) ---
    let profileData = {};
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbx1De4yNN9U7iq7RgzDypUwtTVG7vrNEOUlVB4T2V4PBEsFfmcXF-0Xr-pznbtYDipi_Q/exec';
    const liffId = '1655096741-YPLwoz9w';
    const dashboardUrl = 'https://liff.line.me/1655096741-2XyNm1wN';
    const liffAppUrl = 'https://liff.line.me/1655096741-YPLwoz9w';

    $(document).ready(function() {
      if(window.liff) {
        liff.init({
          liffId: liffId,
          withLoginOnExternalBrowser: true,
          scope: ["profile","openid"]
        }).then(() => {
          liff.getProfile().then(function(profile){
            profileData = profile;
            $("#profilePic").attr("src", profile.pictureUrl).removeClass("d-none");
            $("#profileName").text(profile.displayName);
            if (!$('#inspector').val()) $('#inspector').val(profile.displayName);
          });
        }).catch(() => {
          $("#profilePic").attr("src", "https://via.placeholder.com/80/9fffcf/18805c?text=USER").removeClass("d-none");
          $("#profileName").text("ผู้ใช้งาน (ทดสอบ)");
          if (!$('#inspector').val()) $('#inspector').val("ผู้ใช้งาน (ทดสอบ)");
        });
      } else {
        $("#profilePic").attr("src", "https://via.placeholder.com/80/9fffcf/18805c?text=USER").removeClass("d-none");
        $("#profileName").text("ผู้ใช้งาน (ทดสอบ)");
        if (!$('#inspector').val()) $('#inspector').val("ผู้ใช้งาน (ทดสอบ)");
      }
    });

        // URL ของ Google Apps Script Web App
        const API_URL = 'https://script.google.com/macros/s/AKfycbxRMxbCBeHMZb4nRTU-i8M61vs_M2ch7FjwTRz0vbLwactnhpoll1fSivIRL-sRrHr7/exec';
        
        // ตัวแปรสำหรับเก็บข้อมูลยาทั้งหมด
        let medicineData = [];
        let currentRowIndex = null;
        let originalSheetRowIndices = []; // เก็บ index จริงของแถวในชีต
        
        // Modal instances
        let medicineModal;
        let deleteConfirmModal;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap modals
            medicineModal = new bootstrap.Modal(document.getElementById('medicineModal'));
            deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            
            // โหลดข้อมูลเมื่อเปิดหน้าเว็บ
            fetchMedicineData();
            
            // Event listeners
            document.getElementById('refreshData').addEventListener('click', fetchMedicineData);
            document.getElementById('addNewItem').addEventListener('click', showAddNewItemModal);
            document.getElementById('saveChanges').addEventListener('click', saveMedicineData);
            document.getElementById('confirmDelete').addEventListener('click', deleteMedicineItem);
            document.getElementById('searchInput').addEventListener('input', filterTable);
            document.getElementById('expiryDate').addEventListener('change', calculateDaysUntilExpiry);
            
            // ตั้งเวลาอัพเดทข้อมูลทุก 6 ชั่วโมง
            setInterval(updateExpiryDates, 6 * 60 * 60 * 1000);
        });
        
        // ฟังก์ชันดึงข้อมูลจาก Google Sheet
        function fetchMedicineData() {
            showLoading(true);
            
            fetch(API_URL + '?action=getData')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // เก็บข้อมูลที่มีชื่อยาไม่ว่างเท่านั้น
                        medicineData = data.data.filter(item => item[0] && item[0].trim() !== '');
                        
                        // เก็บ index จริงของแถวในชีต (แถวแรกคือหัวตาราง ดังนั้น index จริงคือ i+2)
                        originalSheetRowIndices = [];
                        for (let i = 0; i < data.data.length; i++) {
                            if (data.data[i][0] && data.data[i][0].trim() !== '') {
                                originalSheetRowIndices.push(i + 2);
                            }
                        }
                        
                        processMedicineData();
                        renderTable();
                        showNotification('ดึงข้อมูลสำเร็จ', 'success');
                    } else {
                        showNotification('เกิดข้อผิดพลาด: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showNotification('ไม่สามารถดึงข้อมูลได้ กรุณาลองใหม่อีกครั้ง', 'danger');
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        // ประมวลผลข้อมูลยา คำนวณวันที่ใกล้หมดอายุและสถานะ
        function processMedicineData() {
            const today = new Date();
            
            medicineData = medicineData.map(item => {
                // แปลงวันที่หมดอายุจากรูปแบบ M/D/YYYY เป็น Date object
                let expiryDateStr = item[1];
                let expiryDate;
                
                if (expiryDateStr) {
                    // รองรับรูปแบบวันที่หลายแบบ
                    if (typeof expiryDateStr === 'string' && expiryDateStr.includes('/')) {
                        const parts = expiryDateStr.split('/');
                        // รูปแบบ M/D/YYYY
                        expiryDate = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else if (typeof expiryDateStr === 'string' && expiryDateStr.includes('-')) {
                        // รูปแบบ YYYY-MM-DD
                        expiryDate = new Date(expiryDateStr);
                    } else if (expiryDateStr instanceof Date) {
                        expiryDate = expiryDateStr;
                    } else {
                        // ถ้าไม่ตรงกับรูปแบบใดๆ ให้ใช้วันที่ปัจจุบัน
                        expiryDate = new Date();
                    }
                } else {
                    // ถ้าไม่มีวันที่หมดอายุ ให้ใช้วันที่ปัจจุบัน
                    expiryDate = new Date();
                }
                
                // คำนวณจำนวนวันที่เหลือก่อนหมดอายุ
                const timeDiff = expiryDate - today;
                const daysUntilExpiry = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                
                // กำหนดสถานะตามจำนวนวันที่เหลือ
                let status;
                if (daysUntilExpiry < 0) {
                    status = "หมดอายุ ห้ามใช้!!";
                } else if (daysUntilExpiry < 180) {
                    status = "ใกล้หมดอายุ";
                } else if (daysUntilExpiry < 210) {
                    status = "รีบแลกยาด่วน";
                } else {
                    status = "ปกติ";
                }
                
                // อัพเดทข้อมูล
                item[2] = daysUntilExpiry;
                item[3] = status;
                
                return item;
            });
            
            // เรียงลำดับตามจำนวนวันที่ใกล้หมดอายุ (น้อยไปมาก)
            // ต้องเรียงลำดับทั้ง medicineData และ originalSheetRowIndices พร้อมกัน
            const combinedData = medicineData.map((item, index) => {
                return {
                    data: item,
                    sheetRowIndex: originalSheetRowIndices[index]
                };
            });
            
            combinedData.sort((a, b) => a.data[2] - b.data[2]);
            
            // แยกข้อมูลกลับ
            medicineData = combinedData.map(item => item.data);
            originalSheetRowIndices = combinedData.map(item => item.sheetRowIndex);
        }
        
        // แสดงข้อมูลในตาราง
        function renderTable() {
            const tableBody = document.getElementById('medicineTableBody');
            tableBody.innerHTML = '';
            
            medicineData.forEach((item, index) => {
                const medicineName = item[0];
                const daysUntilExpiry = item[2];
                const status = item[3];
                
                // สร้างแถวใหม่
                const row = document.createElement('tr');
                
                // กำหนดคลาสตามสถานะ
                if (daysUntilExpiry < 0) {
                    row.classList.add('status-expired');
                } else if (daysUntilExpiry < 180) {
                    row.classList.add('status-near-expired');
                } else if (daysUntilExpiry < 210) {
                    row.classList.add('status-warning');
                } else {
                    row.classList.add('status-normal');
                }
                
                // สร้าง HTML สำหรับแถว
                row.innerHTML = `
                    <td>${medicineName}</td>
                    <td class="days-column">${daysUntilExpiry} วัน</td>
                    <td>
                        <span class="badge ${getBadgeClass(status)} p-2">
                            ${getStatusIcon(status)} ${status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary action-btn view-btn" data-index="${index}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger action-btn delete-btn" data-index="${index}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // เพิ่ม event listeners สำหรับปุ่มในตาราง
            addTableButtonListeners();
        }
        
        // เพิ่ม event listeners สำหรับปุ่มในตาราง
        function addTableButtonListeners() {
            // ปุ่มดูรายละเอียด
            document.querySelectorAll('.view-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    showMedicineDetails(index);
                });
            });
            
            // ปุ่มลบ
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    showDeleteConfirmation(index);
                });
            });
        }
        
        // คำนวณจำนวนวันที่ใกล้หมดอายุแบบเรียลไทม์
        function calculateDaysUntilExpiry() {
            const expiryDateInput = document.getElementById('expiryDate').value;
            if (!expiryDateInput) return;
            
            const expiryDate = new Date(expiryDateInput);
            const today = new Date();
            
            // คำนวณจำนวนวันที่เหลือ
            const timeDiff = expiryDate - today;
            const daysUntilExpiry = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            
            // กำหนดสถานะ
            let status;
            if (daysUntilExpiry < 0) {
                status = "หมดอายุ ห้ามใช้!!";
            } else if (daysUntilExpiry < 180) {
                status = "ใกล้หมดอายุ";
            } else if (daysUntilExpiry < 210) {
                status = "รีบแลกยาด่วน";
            } else {
                status = "ปกติ";
            }
            
            // อัพเดทค่าในฟอร์ม
            document.getElementById('daysUntilExpiry').value = daysUntilExpiry;
            document.getElementById('status').value = status;
            
            // เปลี่ยนสีของช่องสถานะตามสถานะ
            const statusInput = document.getElementById('status');
            statusInput.className = 'form-control';
            
            if (daysUntilExpiry < 0) {
                statusInput.style.backgroundColor = 'var(--mint-danger-dark)';
                statusInput.style.color = 'white';
            } else if (daysUntilExpiry < 180) {
                statusInput.style.backgroundColor = 'var(--mint-danger)';
                statusInput.style.color = 'black';
            } else if (daysUntilExpiry < 210) {
                statusInput.style.backgroundColor = 'var(--mint-warning)';
                statusInput.style.color = 'black';
            } else {
                statusInput.style.backgroundColor = 'var(--mint-success)';
                statusInput.style.color = 'black';
            }
        }
        
        // แสดง Modal รายละเอียดยา
        function showMedicineDetails(index) {
            const item = medicineData[index];
            currentRowIndex = index;
            
            document.getElementById('rowIndex').value = index;
            document.getElementById('sheetRowIndex').value = originalSheetRowIndices[index];
            document.getElementById('medicineName').value = item[0];
            
            // แปลงวันที่หมดอายุเป็นรูปแบบ YYYY-MM-DD สำหรับ input type="date"
            let expiryDateStr = item[1];
            let expiryDate;
            
            if (expiryDateStr) {
                if (typeof expiryDateStr === 'string' && expiryDateStr.includes('/')) {
                    const parts = expiryDateStr.split('/');
                    // รูปแบบ M/D/YYYY
                    expiryDate = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                } else if (typeof expiryDateStr === 'string' && expiryDateStr.includes('-')) {
                    // รูปแบบ YYYY-MM-DD
                    expiryDate = new Date(expiryDateStr);
                } else if (expiryDateStr instanceof Date) {
                    expiryDate = expiryDateStr;
                } else {
                    expiryDate = new Date();
                }
            } else {
                expiryDate = new Date();
            }
            
            const formattedDate = expiryDate.toISOString().split('T')[0];
            document.getElementById('expiryDate').value = formattedDate;
            
            document.getElementById('daysUntilExpiry').value = item[2];
            document.getElementById('status').value = item[3];
            document.getElementById('notes').value = item[4] || '';
            
            // เปลี่ยนสีของช่องสถานะตามสถานะ
            const statusInput = document.getElementById('status');
            statusInput.className = 'form-control';
            
            if (item[2] < 0) {
                statusInput.style.backgroundColor = 'var(--mint-danger-dark)';
                statusInput.style.color = 'white';
            } else if (item[2] < 180) {
                statusInput.style.backgroundColor = 'var(--mint-danger)';
                statusInput.style.color = 'black';
            } else if (item[2] < 210) {
                statusInput.style.backgroundColor = 'var(--mint-warning)';
                statusInput.style.color = 'black';
            } else {
                statusInput.style.backgroundColor = 'var(--mint-success)';
                statusInput.style.color = 'black';
            }
            
            document.getElementById('modalTitle').textContent = 'แก้ไขข้อมูล: ' + item[0];
            medicineModal.show();
        }
        
        // แสดง Modal เพิ่มรายการใหม่
        function showAddNewItemModal() {
            currentRowIndex = null;
            
            document.getElementById('rowIndex').value = '';
            document.getElementById('sheetRowIndex').value = '';
            document.getElementById('medicineName').value = '';
            document.getElementById('expiryDate').value = '';
            document.getElementById('daysUntilExpiry').value = '';
            document.getElementById('status').value = '';
            document.getElementById('notes').value = '';
            
            // รีเซ็ตสีของช่องสถานะ
            const statusInput = document.getElementById('status');
            statusInput.style.backgroundColor = '';
            statusInput.style.color = '';
            
            document.getElementById('modalTitle').textContent = 'เพิ่มรายการใหม่';
            medicineModal.show();
        }
        
        // แสดง Modal ยืนยันการลบ
        function showDeleteConfirmation(index) {
            const item = medicineData[index];
            currentRowIndex = index;
            
            document.getElementById('deleteItemName').textContent = item[0];
            deleteConfirmModal.show();
        }
        
        // บันทึกข้อมูลยา (เพิ่มใหม่หรือแก้ไข)
        function saveMedicineData() {
            const medicineName = document.getElementById('medicineName').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const daysUntilExpiry = parseInt(document.getElementById('daysUntilExpiry').value);
            const status = document.getElementById('status').value;
            const notes = document.getElementById('notes').value;
            
            if (!medicineName || !expiryDate) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
                return;
            }
            
            showLoading(true);
            
            // แปลงวันที่เป็นรูปแบบ M/D/YYYY
            const dateObj = new Date(expiryDate);
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}/${dateObj.getFullYear()}`;
            
            // สร้างข้อมูลที่จะส่งไป
            const data = {
                action: currentRowIndex !== null ? 'updateData' : 'addData',
                rowIndex: currentRowIndex !== null ? originalSheetRowIndices[currentRowIndex] : null,
                data: [
                    medicineName,
                    formattedDate,
                    daysUntilExpiry,
                    status,
                    notes
                ]
            };
            
            // ส่งข้อมูลไปยัง Google Apps Script
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain', // เปลี่ยนเป็น text/plain เพื่อหลีกเลี่ยงปัญหา CORS
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text(); // ใช้ text() แทน json() เพื่อรองรับการตอบกลับที่อาจไม่ใช่ JSON
            })
            .then(responseText => {
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    // ถ้าไม่สามารถแปลงเป็น JSON ได้ ให้สร้าง object ขึ้นมาเอง
                    result = { success: true, message: 'บันทึกข้อมูลสำเร็จ' };
                }
                
                medicineModal.hide();
                fetchMedicineData(); // โหลดข้อมูลใหม่
                showNotification(currentRowIndex !== null ? 'อัพเดทข้อมูลสำเร็จ' : 'เพิ่มข้อมูลสำเร็จ', 'success');
            })
            .catch(error => {
                console.error('Error saving data:', error);
                
                // ทดลองบันทึกข้อมูลแบบ JSONP
                tryJSONPRequest(data);
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // ทดลองใช้ JSONP เพื่อหลีกเลี่ยงปัญหา CORS
        function tryJSONPRequest(data) {
            // สร้าง URL สำหรับ JSONP request
            const jsonpUrl = `${API_URL}?action=${data.action}&data=${encodeURIComponent(JSON.stringify(data.data))}`;
            
            // สร้าง script element
            const script = document.createElement('script');
            script.src = jsonpUrl;
            
            // กำหนด callback function
            window.handleJSONPResponse = function(response) {
                if (response && response.success) {
                    medicineModal.hide();
                    fetchMedicineData();
                    showNotification(currentRowIndex !== null ? 'อัพเดทข้อมูลสำเร็จ' : 'เพิ่มข้อมูลสำเร็จ', 'success');
                } else {
                    showNotification('ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง', 'danger');
                }
                
                // ลบ script element
                document.body.removeChild(script);
            };
            
            // เพิ่ม script เข้าไปใน DOM
            document.body.appendChild(script);
            
            // ตั้งเวลาลบ script หลังจาก 10 วินาที (ป้องกันกรณีไม่ได้รับการตอบกลับ)
            setTimeout(() => {
                if (document.body.contains(script)) {
                    document.body.removeChild(script);
                    showNotification('ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง', 'danger');
                }
            }, 10000);
        }
        
        // ลบรายการยา
        function deleteMedicineItem() {
            if (currentRowIndex === null) return;
            
            showLoading(true);
            
            const data = {
                action: 'deleteData',
                rowIndex: originalSheetRowIndices[currentRowIndex]
            };
            
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain', // เปลี่ยนเป็น text/plain เพื่อหลีกเลี่ยงปัญหา CORS
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(responseText => {
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    result = { success: true, message: 'ลบข้อมูลสำเร็จ' };
                }
                
                deleteConfirmModal.hide();
                fetchMedicineData(); // โหลดข้อมูลใหม่
                showNotification('ลบข้อมูลสำเร็จ', 'success');
            })
            .catch(error => {
                console.error('Error deleting data:', error);
                showNotification('ไม่สามารถลบข้อมูลได้ กรุณาลองใหม่อีกครั้ง', 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // อัพเดทวันที่ใกล้หมดอายุและสถานะ
        function updateExpiryDates() {
            showLoading(true);
            
            const data = {
                action: 'updateExpiryDates'
            };
            
            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(responseText => {
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    result = { success: true, message: 'อัพเดทวันที่หมดอายุสำเร็จ' };
                }
                
                fetchMedicineData(); // โหลดข้อมูลใหม่
                showNotification('อัพเดทวันที่หมดอายุสำเร็จ', 'success');
            })
            .catch(error => {
                console.error('Error updating expiry dates:', error);
                showNotification('ไม่สามารถอัพเดทวันที่หมดอายุได้', 'danger');
            })
            .finally(() => {
                showLoading(false);
            });
        }
        
        // ค้นหาข้อมูลในตาราง
        function filterTable() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.getElementById('medicineTableBody').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const medicineName = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
                
                if (medicineName.includes(searchText)) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }
        
        // Helper functions
        function getBadgeClass(status) {
            if (status === "หมดอายุ ห้ามใช้!!") return "bg-danger";
            if (status === "ใกล้หมดอายุ") return "bg-warning text-dark";
            if (status === "รีบแลกยาด่วน") return "bg-warning text-dark";
            return "bg-success";
        }
        
        function getStatusIcon(status) {
            if (status === "หมดอายุ ห้ามใช้!!") return '<i class="bi bi-x-circle-fill"></i>';
            if (status === "ใกล้หมดอายุ") return '<i class="bi bi-exclamation-circle"></i>';
            if (status === "รีบแลกยาด่วน") return '<i class="bi bi-clock"></i>';
            return '<i class="bi bi-check-circle"></i>';
        }
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            
            notification.className = 'alert alert-' + type + ' alert-dismissible fade show';
            notificationMessage.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
// ฟังก์ชันอื่นๆ saveEditedDrug, addNewDrug, deleteDrug (เหมือนโค้ดแคนวา)
    // Update recordId
    document.getElementById('shift').addEventListener('change', function(){
      const shift = this.value;
      const today = new Date();
      const dayStr = today.toLocaleDateString('th-TH', {year: 'numeric', month: '2-digit', day: '2-digit'});
      document.getElementById('recordId').value = shift ? `${dayStr}_${shift}` : '';
    });

    // === QR Scan logic: SINGLE permission, section1 only ===
    let qrModal = new bootstrap.Modal(document.getElementById('qr-modal'), { backdrop: 'static' });
    let qrInstance = null;
    let cameraId = null;
    let cameraPromise = null;
    let unlockedSection1 = false;
    let isScanning = false;

    document.getElementById('scan-section1-btn').addEventListener('click', function() {
      if (isScanning) return;
      $('#qr-modal').modal('show');
    });

    async function getCameraId() {
      if (!cameraPromise) {
        cameraPromise = Html5Qrcode.getCameras();
      }
      const devices = await cameraPromise;
      if (!devices || devices.length === 0) throw new Error('ไม่พบกล้อง');
      let back = devices.find(d => /back|environment/i.test(d.label));
      cameraId = (back && back.id) ? back.id : devices[0].id;
      return cameraId;
    }

    $('#qr-modal').on('shown.bs.modal', async function () {
      if (isScanning) return;
      isScanning = true;
      try {
        if (!qrInstance) {
          qrInstance = new Html5Qrcode("qr-reader");
        }
        const devId = await getCameraId();
        await qrInstance.start(
          { deviceId: { exact: devId } },
          { fps: 10, qrbox: 200 },
          (decodedText, decodedResult) => {
            if (decodedText === 'A094B184C3548') {
              unlockedSection1 = true;
              qrInstance.stop().then(() => {
                ['section1','section2','section3','section4','section5'].forEach(id=>{
                  document.getElementById(id).classList.remove('d-none');
                });
                Swal.fire({
                  icon: 'success',
                  title: 'QR code ถูกต้อง!',
                  timer: 900,
                  showConfirmButton: false,
                  allowOutsideClick: false,
                  allowEscapeKey: false,
                });
                setTimeout(() => $('#qr-modal').modal('hide'), 950);
                isScanning = false;
              });
            } else {
              Swal.fire('QR ไม่ถูกต้อง', 'กรุณาสแกน QR Code ที่ถูกต้อง', 'error');
            }
          },
          (errorMessage) => {}
        );
      } catch (err) {
        Swal.fire('ไม่พบกล้อง หรือไม่ได้อนุญาต', '', 'error');
        $('#qr-modal').modal('hide');
        isScanning = false;
      }
    });

    $('#qr-modal').on('hidden.bs.modal', function () {
      if (qrInstance) qrInstance.stop().catch(()=>{});
      isScanning = false;
    });

    // Signature pad (เหมือนเดิม)
    const canvas = document.getElementById('signaturePad');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = "#24d4a3";
    canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); });
    canvas.addEventListener('mouseup', e => { drawing = false; });
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('touchstart', e => { drawing = true; ctx.beginPath(); });
    canvas.addEventListener('touchend', e => { drawing = false; });
    canvas.addEventListener('touchmove', function(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      const touch = e.touches[0];
      ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
      ctx.stroke();
      e.preventDefault();
    }, {passive:false});
    function draw(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
    }
    document.getElementById('clear-signature').onclick = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      ctx.scale(ratio, ratio);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // ฟังก์ชันบันทึก (เหมือนเดิม)
    function sendFlex(profile, data) {
      let flex = {
        type: 'flex',
        altText: 'บันทึกข้อมูล Emergency Car',
        contents: {
          type: "bubble",
          body: {
            type: "box",
            layout: "vertical",
            contents: [
              {
                type: "box",
                layout: "horizontal",
                contents: [
                  {
                    type: "box",
                    layout: "vertical",
                    contents: [
                      {
                        type: "image",
                        url: profile.pictureUrl,
                        aspectMode: "cover",
                        size: "full"
                      }
                    ],
                    cornerRadius: "100px",
                    width: "72px",
                    height: "72px"
                  },
                  {
                    type: "box",
                    layout: "vertical",
                    contents: [
                      {
                        type: "text",
                        contents: [
                          {
                            type: "span",
                            text: " " + data.inspector,
                            weight: "bold",
                            color: "#000000"
                          }
                        ],
                        size: "sm",
                        wrap: true
                      },
                      {
                        type: "box",
                        layout: "vertical",
                        contents: [
                          {
                            type: "text",
                            text: "รายงาน Emergency Car 🚑",
                            size: "sm",
                            color: "#24d4a3",
                            weight: "bold",
                            action: {
                              type: "uri",
                              label: "รายงาน",
                              uri: dashboardUrl
                            }
                          }
                        ]
                      }
                    ]
                  }
                ],
                spacing: "xl",
                paddingAll: "20px",
                backgroundColor: "#eafff6"
              },
              {
                type: "box",
                layout: "vertical",
                contents: [
                  {
                    type: "text",
                    text: "📆 เวร: " + (data.shift ? data.shift : ""),
                    size: "sm",
                    weight: "bold",
                    color: "#24d4a3"
                  },
                  {
                    type: "text",
                    text: "ID: " + (data.recordId || ""),
                    size: "xs"
                  }
                ],
                spacing: "xs",
                paddingAll: "14px"
              }
            ],
            paddingAll: "0px"
          },
          footer: {
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "text",
                "text": "ตรวจสอบความพร้อมรถ Emergency",
                "position": "relative",
                "weight": "bold",
                "align": "center",
                "action": {
                  "type": "uri",
                  "label": "action",
                  "uri": liffAppUrl
                }
              }
            ]
          },
          styles: {
            body: {
              backgroundColor: "#eafff6"
            }
          }
        }
      };
      return flex;
    }

    $('#emergency-check-form').on('submit', function(e) {
      e.preventDefault();
      let form = this;
      let valid = form.checkValidity();
      if (!valid) {
        Swal.fire({
          icon: 'warning',
          title: 'กรุณาลงข้อมูลให้ครบถ้วนก่อน',
          confirmButtonText: 'ตกลง'
        });
        form.classList.add('was-validated');
        return;
      }
      $.LoadingOverlay('show');
      let formData = {};
      $(this).serializeArray().forEach(item => { formData[item.name] = item.value; });
      formData['signature'] = canvas.toDataURL();
      formData.timestamp = new Date().toISOString();

      const submitData = (profile) => {
        const uid = profile && liff.getDecodedIDToken ? liff.getDecodedIDToken().sub : 'test_user_id';
        formData.opt = 'savedata';
        formData.uid = uid;
        $.ajax({
          method: "POST",
          url: scriptUrl,
          data: formData,
          dataType: 'json',
          success: function (res) {
            $.LoadingOverlay('hide');
            if(res && res.status === "success") {
              Swal.fire({
                icon: 'success',
                title: 'บันทึกข้อมูลสำเร็จ!',
                showConfirmButton: false,
                timer: 1200,
                allowOutsideClick: false,
                allowEscapeKey: false
              });
              setTimeout(() => {
                if (window.liff && liff.sendMessages) {
                  let flex = sendFlex(profile, formData);
                  liff.sendMessages([flex]).then(() => {
                    liff.closeWindow();
                  }).catch(() => {
                    liff.closeWindow();
                  });
                }
              }, 1200);
            } else {
              Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาดในการบันทึกข้อมูล',
                text: res.message || 'โปรดลองอีกครั้ง',
                allowOutsideClick: false,
                confirmButtonText: 'ตกลง'
              });
            }
          },
          error: function () {
            $.LoadingOverlay('hide');
            Swal.fire({
              icon: 'error',
              title: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
              text: 'โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตหรือลองอีกครั้ง',
              allowOutsideClick: false,
              confirmButtonText: 'ตกลง'
            });
          }
        });
      };

      if(window.liff && liff.getProfile) {
        liff.init({
          liffId: liffId,
          withLoginOnExternalBrowser: true,
          scope: ["profile","openid"]
        }).then(() => {
          liff.getProfile().then(function(profile){
            submitData(profile);
          }).catch(() => {
            submitData(null);
          });
        }).catch(() => {
          submitData(null);
        });
      } else {
        submitData(null);
      }
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9573d9d7d01410e2',t:'MTc1MTE4MzYxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
